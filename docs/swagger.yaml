openapi: 3.0.3
info:
  title: Flight Search API
  description: |
    A flight search aggregation API that fetches from multiple Indonesian airline providers,
    normalizes data, and returns unified search results with filtering and sorting capabilities.

    ## Features
    - Multi-provider aggregation (Garuda, Lion Air, Batik Air, AirAsia)
    - Flexible filtering (price, stops, airlines, time windows)
    - Multiple sort options including best value scoring
    - Round-trip search support
    - Indonesia timezone handling (WIB/WITA/WIT)

    ## Airline Codes
    | Code | Airline |
    |------|---------|
    | GA | Garuda Indonesia |
    | JT | Lion Air |
    | ID | Batik Air |
    | QZ | AirAsia Indonesia |
  version: 1.0.0
  contact:
    name: API Support
    email: support@example.com

servers:
  - url: http://localhost:8080
    description: Local development server

tags:
  - name: Flights
    description: Flight search operations
  - name: Health
    description: Health check endpoints

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Returns the health status of the API server
      operationId: healthCheck
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: ok

  /api/v1/flights/search:
    post:
      tags:
        - Flights
      summary: Search flights
      description: |
        Search for flights across all providers with optional filtering and sorting.

        Supports both one-way and round-trip searches. For round-trip, include the `return_date` field.

        Results are cached for 5 minutes based on search criteria.
      operationId: searchFlights
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SearchRequest'
            examples:
              basic:
                summary: Basic search
                value:
                  origin: CGK
                  destination: DPS
                  departure_date: "2025-12-15"
                  passengers: 1
                  cabin_class: economy
              withFilters:
                summary: Search with filters
                value:
                  origin: CGK
                  destination: DPS
                  departure_date: "2025-12-15"
                  passengers: 1
                  cabin_class: economy
                  filters:
                    price_max: 1500000
                    max_stops: 0
                    departure_time_min: "06:00"
                    departure_time_max: "18:00"
                  sort_by: best_value
                  sort_order: asc
              roundTrip:
                summary: Round-trip search
                value:
                  origin: CGK
                  destination: DPS
                  departure_date: "2025-12-15"
                  return_date: "2025-12-20"
                  passengers: 2
                  cabin_class: economy
                  sort_by: price
                  sort_order: asc
      responses:
        '200':
          description: Successful search
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/SearchResponse'
                  - $ref: '#/components/schemas/RoundTripResponse'
              examples:
                oneWay:
                  summary: One-way search response
                  value:
                    search_criteria:
                      origin: CGK
                      destination: DPS
                      departure_date: "2025-12-15"
                      passengers: 1
                      cabin_class: economy
                      sort_by: price
                      sort_order: asc
                    metadata:
                      total_results: 20
                      providers_queried: 4
                      providers_succeeded: 4
                      providers_failed: 0
                      search_time_ms: 285
                      cache_hit: false
                    flights:
                      - id: QZ-001
                        provider: airasia
                        airline:
                          code: QZ
                          name: AirAsia Indonesia
                        flight_number: QZ 7520
                        departure:
                          airport: CGK
                          city: Jakarta
                          time: "2025-12-15T06:30:00+07:00"
                          timezone: WIB
                        arrival:
                          airport: DPS
                          city: Bali
                          time: "2025-12-15T09:15:00+08:00"
                          timezone: WITA
                        duration:
                          hours: 1
                          minutes: 45
                          total_minutes: 105
                        stops: 0
                        price:
                          amount: 650000
                          currency: IDR
                          formatted: "IDR 650.000"
                        available_seats: 85
                        cabin_class: economy
                        aircraft: Airbus A320
                        baggage:
                          cabin_kg: 7
                          checked_kg: 0
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                missingOrigin:
                  summary: Missing origin
                  value:
                    error: validation_error
                    message: origin is required
                    code: 400
                missingDate:
                  summary: Missing departure date
                  value:
                    error: validation_error
                    message: departure_date is required
                    code: 400
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: search_error
                message: Failed to search flights
                code: 500

components:
  schemas:
    SearchRequest:
      type: object
      required:
        - origin
        - destination
        - departure_date
      properties:
        origin:
          type: string
          minLength: 3
          maxLength: 3
          description: Origin airport IATA code
          example: CGK
        destination:
          type: string
          minLength: 3
          maxLength: 3
          description: Destination airport IATA code
          example: DPS
        departure_date:
          type: string
          format: date
          description: Departure date (YYYY-MM-DD)
          example: "2025-12-15"
        return_date:
          type: string
          format: date
          nullable: true
          description: Return date for round-trip (YYYY-MM-DD)
          example: "2025-12-20"
        passengers:
          type: integer
          minimum: 1
          maximum: 9
          default: 1
          description: Number of passengers
          example: 1
        cabin_class:
          type: string
          enum: [economy, business, first]
          default: economy
          description: Cabin class
          example: economy
        filters:
          $ref: '#/components/schemas/SearchFilters'
        sort_by:
          type: string
          enum: [price, duration, departure, arrival, stops, best_value]
          default: price
          description: Sort criteria
          example: price
        sort_order:
          type: string
          enum: [asc, desc]
          default: asc
          description: Sort order
          example: asc

    SearchFilters:
      type: object
      description: Optional filters to narrow search results
      properties:
        price_min:
          type: number
          format: float
          minimum: 0
          description: Minimum price in IDR
          example: 500000
        price_max:
          type: number
          format: float
          minimum: 0
          description: Maximum price in IDR
          example: 2000000
        max_stops:
          type: integer
          minimum: 0
          maximum: 3
          description: Maximum number of stops (0 = direct only)
          example: 1
        airlines:
          type: array
          items:
            type: string
          description: Whitelist of airline codes
          example: ["GA", "JT"]
        departure_time_min:
          type: string
          pattern: '^([01]?[0-9]|2[0-3]):[0-5][0-9]$'
          description: Earliest departure time (HH:MM)
          example: "06:00"
        departure_time_max:
          type: string
          pattern: '^([01]?[0-9]|2[0-3]):[0-5][0-9]$'
          description: Latest departure time (HH:MM)
          example: "18:00"
        arrival_time_min:
          type: string
          pattern: '^([01]?[0-9]|2[0-3]):[0-5][0-9]$'
          description: Earliest arrival time (HH:MM)
          example: "08:00"
        arrival_time_max:
          type: string
          pattern: '^([01]?[0-9]|2[0-3]):[0-5][0-9]$'
          description: Latest arrival time (HH:MM)
          example: "22:00"
        max_duration:
          type: integer
          minimum: 0
          description: Maximum flight duration in minutes
          example: 180

    SearchResponse:
      type: object
      properties:
        search_criteria:
          $ref: '#/components/schemas/SearchCriteria'
        metadata:
          $ref: '#/components/schemas/SearchMetadata'
        flights:
          type: array
          items:
            $ref: '#/components/schemas/Flight'

    RoundTripResponse:
      type: object
      properties:
        search_criteria:
          $ref: '#/components/schemas/SearchCriteria'
        metadata:
          $ref: '#/components/schemas/SearchMetadata'
        outbound_flights:
          type: array
          items:
            $ref: '#/components/schemas/Flight'
        return_flights:
          type: array
          items:
            $ref: '#/components/schemas/Flight'

    SearchCriteria:
      type: object
      properties:
        origin:
          type: string
          example: CGK
        destination:
          type: string
          example: DPS
        departure_date:
          type: string
          example: "2025-12-15"
        return_date:
          type: string
          nullable: true
          example: "2025-12-20"
        passengers:
          type: integer
          example: 1
        cabin_class:
          type: string
          example: economy
        filters:
          $ref: '#/components/schemas/SearchFilters'
        sort_by:
          type: string
          example: price
        sort_order:
          type: string
          example: asc

    SearchMetadata:
      type: object
      properties:
        total_results:
          type: integer
          description: Number of flights returned
          example: 20
        providers_queried:
          type: integer
          description: Number of providers queried
          example: 4
        providers_succeeded:
          type: integer
          description: Number of providers that returned results
          example: 4
        providers_failed:
          type: integer
          description: Number of providers that failed
          example: 0
        failed_providers:
          type: array
          items:
            type: string
          description: Names of failed providers
          example: []
        search_time_ms:
          type: integer
          format: int64
          description: Search duration in milliseconds
          example: 285
        cache_hit:
          type: boolean
          description: Whether results came from cache
          example: false

    Flight:
      type: object
      properties:
        id:
          type: string
          description: Unique flight identifier
          example: QZ-001
        provider:
          type: string
          description: Provider name
          example: airasia
        airline:
          $ref: '#/components/schemas/Airline'
        flight_number:
          type: string
          description: Flight number
          example: QZ 7520
        departure:
          $ref: '#/components/schemas/Location'
        arrival:
          $ref: '#/components/schemas/Location'
        duration:
          $ref: '#/components/schemas/Duration'
        stops:
          type: integer
          description: Number of stops
          example: 0
        layovers:
          type: array
          items:
            $ref: '#/components/schemas/Layover'
        price:
          $ref: '#/components/schemas/Price'
        available_seats:
          type: integer
          description: Number of available seats
          example: 85
        cabin_class:
          type: string
          description: Cabin class
          example: economy
        aircraft:
          type: string
          nullable: true
          description: Aircraft type
          example: Airbus A320
        amenities:
          type: array
          items:
            type: string
          description: Available amenities
          example: ["wifi", "meal", "entertainment"]
        baggage:
          $ref: '#/components/schemas/Baggage'
        best_value_score:
          type: number
          format: float
          description: Best value score (lower is better, only present when sorting by best_value)
          example: 62.85

    Airline:
      type: object
      properties:
        code:
          type: string
          description: IATA airline code
          example: QZ
        name:
          type: string
          description: Airline name
          example: AirAsia Indonesia

    Location:
      type: object
      properties:
        airport:
          type: string
          description: IATA airport code
          example: CGK
        city:
          type: string
          description: City name
          example: Jakarta
        terminal:
          type: string
          nullable: true
          description: Terminal number
          example: "3"
        time:
          type: string
          format: date-time
          description: Local time with timezone offset
          example: "2025-12-15T06:30:00+07:00"
        timezone:
          type: string
          description: Indonesia timezone name
          enum: [WIB, WITA, WIT]
          example: WIB

    Duration:
      type: object
      properties:
        hours:
          type: integer
          description: Hours component
          example: 1
        minutes:
          type: integer
          description: Minutes component
          example: 45
        total_minutes:
          type: integer
          description: Total duration in minutes
          example: 105

    Layover:
      type: object
      properties:
        airport:
          type: string
          description: Layover airport code
          example: SUB
        city:
          type: string
          description: Layover city name
          example: Surabaya
        duration_minutes:
          type: integer
          description: Layover duration in minutes
          example: 60

    Price:
      type: object
      properties:
        amount:
          type: number
          format: float
          description: Price amount
          example: 650000
        currency:
          type: string
          description: Currency code
          example: IDR
        formatted:
          type: string
          description: Formatted price string
          example: "IDR 650.000"

    Baggage:
      type: object
      properties:
        cabin_kg:
          type: number
          format: float
          description: Cabin baggage allowance in kg
          example: 7
        checked_kg:
          type: number
          format: float
          description: Checked baggage allowance in kg
          example: 20

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: ok

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Error code
          example: validation_error
        message:
          type: string
          description: Error message
          example: origin is required
        code:
          type: integer
          description: HTTP status code
          example: 400
